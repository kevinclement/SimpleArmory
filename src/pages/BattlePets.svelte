<script>
    import { onMount } from 'svelte'
    import { region, realm, character } from '$stores/user'
    import { getBattlePets } from '$api/battlePets'
    import { percent, percentFormat, getTitle, getImageSrc } from '$util/utils'
    import settings from '$util/settings'
    import ProgressBar from '$components/ProgressBar.svelte';
    import Loading from '$components/Loading.svelte';
    import ErrorInline from '$components/ErrorInline.svelte';
    import { t } from 'svelte-i18n';

    let showLevel
    let battlePets
    $: promise = getBattlePets($region, $realm, $character).then(_ => {
        init(_);
    })
   
    onMount(async () => {
        window.ga('send', 'pageview', 'BattlePets');
    });

    function init(_) {
        if (!_) return;
        battlePets = _;
    }

    function qualityToBackground(item) {
        var bgColor = 'transparent';

        switch(item.quality) {
            case 'poor':
                bgColor = '#7F7F7F';
                break;
            case 'common':
                bgColor = '#F0F0F0';
                break;
            case 'uncommon':
                bgColor = '#22B14C';
                break;
            case 'rare':
                bgColor = '#3F48CC';
                break;
        }

        return 'background:' + bgColor;
    };
</script>

<svelte:head>
	<title>{getTitle($character, $t('pets'))}</title>
</svelte:head>

<div class="container">
<div class="page-header">
    <h2>
        {$t('pets')} <small class="pbSmall"><input type="checkbox" id="showlevels" bind:checked={showLevel}><label for="showlevels">{$t('showLevelsAndBreeds')}</label></small>
        <ProgressBar
            rightSide={true}
            width={battlePets ? percent(battlePets.collected, battlePets.possible) : 0} 
            percentage={battlePets ? percentFormat(battlePets.collected, battlePets.possible) : ""}/>
    </h2>
</div>

{#await promise}
<Loading/>
{:then value}

{#if battlePets}
{#each battlePets.categories as category}
  <h3 class="categoryHeader">{ $t(category.name) }</h3>

  {#each category.subCategories as subCategory}
    <div class="sect">
        <div class="subCatHeader">{ $t(subCategory.name) }</div>
        {#each subCategory.items as item}
            <div class="pbCell">
                <a 
                  class="thumbnail pbThumbnail" 
                  target="{settings.anchorTarget}"
                  href="//{settings.WowHeadUrl}/battle-pet/{ item.ID }"
                  class:borderOn={!item.collected}
                  class:borderOff={item.collected}>
	        	    <img height="36" width="36" src="{getImageSrc(item)}" alt>
	        	    <div class="pbLevel" class:opacityOn={showLevel}>{ item.level }</div>
	        	    <div class="pbBreed" class:opacityOn={showLevel}>{ item.breed }</div>
	      	    </a> 
	   		    <div class="pbQual" style="{ qualityToBackground(item) }"></div>        		      	
            </div>
        {/each}
    </div>
  {/each}
  <div class="clear"/> 
{/each}
{:else}
<ErrorInline page="pets"/>
{/if}

{/await}
</div>
